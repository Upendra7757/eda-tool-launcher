{% extends "launcher/base.html" %}
{% block content %}

<div class="max-w-4xl mx-auto">

  <!-- ================= BACK + HEADER ================= -->
  <div class="flex justify-between items-center mb-6">

    <a href="{% url 'launcher-category' 'custom-layout' %}"
       class="inline-flex items-center gap-2 text-sm text-sub hover:underline">
      ‚Üê Back to Tools
    </a>

    <!-- üî• CREATE PRESENTATION (HIDDEN INITIALLY) -->
    <div id="presentationHeaderBtn" class="hidden">
      <a id="createPresentationLink"
         class="bg-purple-600 hover:bg-purple-500 text-white text-xs px-4 py-2 rounded-lg shadow">
        Create Presentation
      </a>
    </div>

  </div>

  <!-- ================= MAIN CARD ================= -->
  <div class="glass p-8 rounded-2xl shadow-lg">

    <h1 class="text-3xl font-bold mb-2 text-title">
      KLayout Web Workspace
    </h1>

    <p class="text-sub mb-6">
      Upload a GDS file and open it in native KLayout
    </p>

    <!-- ================= FILE INPUT ================= -->
    <input type="file"
           id="gdsFile"
           accept=".gds,.gdsii"
           class="mb-4 block">

    <button onclick="uploadGDS()" class="btn-primary">
      Upload GDS
    </button>

    <div id="status" class="mt-4 text-sm text-sub"></div>

    <!-- ================= OPEN DESKTOP ================= -->
    <button id="openBtn"
            class="btn-secondary mt-6 hidden"
            onclick="openDesktop()">
      Open in Desktop KLayout
    </button>

  </div>
</div>

<script>
let uploadedPath = null;
let presentationUrl = null;

function uploadGDS() {
  const fileInput = document.getElementById("gdsFile");
  const status = document.getElementById("status");

  if (!fileInput || !fileInput.files.length) {
    alert("Please select a GDS file");
    return;
  }

  const fd = new FormData();
  fd.append("file", fileInput.files[0]);

  status.innerText = "Running KLayout batch...";

  fetch("/klayout-run/", {
    method: "POST",
    headers: {
      "X-CSRFToken": "{{ csrf_token }}"
    },
    body: fd
  })
  .then(async (response) => {
    const text = await response.text();

    if (text.trim().startsWith("<")) {
      status.innerText = "Server error (HTML returned)";
      return null;
    }

    return JSON.parse(text);
  })
  .then(d => {
    if (!d) return;

    if (!d.ok) {
      status.innerText = d.error || "Run failed";
      return;
    }

    status.innerText = d.message || "Run completed successfully";

    // ‚úÖ SHOW CREATE PRESENTATION BUTTON (TOP HEADER)
    if (d.redirect) {
      presentationUrl = d.redirect;

      const btn = document.getElementById("presentationHeaderBtn");
      const link = document.getElementById("createPresentationLink");

      link.href = presentationUrl;
      btn.classList.remove("hidden");
    }

    // fallback safety
    uploadedPath = d.gds || null;
    document.getElementById("openBtn").classList.remove("hidden");
  })
  .catch(err => {
    console.error(err);
    status.innerText = "Error: " + err;
  });
}

// ‚úÖ OPEN DESKTOP KLAYOUT (UNCHANGED)
function openDesktop() {
  fetch("/launch-desktop/klayout/", { method: "POST" })
    .then(r => r.json())
    .then(d => alert(d.message || d.error));
}
</script>

{% endblock %}
